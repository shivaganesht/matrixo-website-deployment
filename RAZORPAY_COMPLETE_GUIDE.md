# 🔐 Razorpay Integration - Complete Implementation Guide

## ✅ What's Been Implemented

Your Razorpay integration follows the **official Razorpay documentation** exactly:

### Implementation Pattern Used:
- ✅ **Handler Function Pattern** (recommended by Razorpay)
- ✅ **Payment Failed Event Handler**
- ✅ **Modal Dismiss Handler**
- ✅ **Server-side Signature Verification**

---

## 🎯 How It Works

### Step-by-Step Flow:

1. **User clicks "Register Now"** on event page
2. **Checkout modal opens** with form (Name, Email, Phone)
3. **User fills details** and clicks "Pay ₹XXX - Proceed to Razorpay"
4. **Backend creates Razorpay order** (`/api/create-order`)
5. **Razorpay modal opens** with payment options
6. **User completes payment**
7. **Handler function called** with payment details
8. **Backend verifies signature** (`/api/verify-payment`)
9. **Success message shown** + Email sent (when configured)
10. **Booking saved to database** (when configured)

---

## 🔧 Configuration Required

### Step 1: Get Razorpay Credentials

1. Visit: https://dashboard.razorpay.com/
2. Sign Up / Log In
3. Go to **Settings** → **API Keys**
4. Click **Generate Test Keys** (for development)
5. You'll receive:
   - `Key ID`: starts with `rzp_test_`
   - `Key Secret`: Keep this private!

### Step 2: Update Environment Variables

Edit `.env.local` file:

```env
# Razorpay Test Keys (for development)
RAZORPAY_KEY_ID=rzp_test_YOUR_KEY_ID_HERE
RAZORPAY_KEY_SECRET=YOUR_SECRET_KEY_HERE

# Public key (exposed to frontend - same as RAZORPAY_KEY_ID)
NEXT_PUBLIC_RAZORPAY_KEY_ID=rzp_test_YOUR_KEY_ID_HERE
```

### Step 3: Restart Development Server

```bash
# Stop server (Ctrl+C)
npm run dev
```

---

## 🧪 Testing the Integration

### Test Cards (Razorpay Test Mode)

| Card Number | CVV | Expiry | Result |
|-------------|-----|--------|--------|
| `4111 1111 1111 1111` | 123 | 12/25 | ✅ Success |
| `5555 5555 5555 4444` | 123 | 12/25 | ✅ Success (MasterCard) |
| `4000 0000 0000 0002` | 123 | 12/25 | ❌ Card Declined |
| `4000 0027 6000 0016` | 123 | 12/25 | ❌ Authentication Failed |

**For any card:**
- CVV: Any 3 digits
- Expiry: Any future date
- OTP: 1234 (if OTP screen appears)

### Test UPI (in Test Mode)

- UPI ID: `success@razorpay`
- Result: ✅ Success

### Test Wallets

- Select any wallet
- All wallets succeed in test mode

### Complete Test Flow:

1. **Start server**: `npm run dev`
2. **Go to**: http://localhost:3000/events
3. **Click**: Any event (e.g., "Full-Stack Bootcamp")
4. **Click**: "Register Now" on any ticket
5. **Fill form**:
   - Name: Test User
   - Email: test@youremail.com
   - Phone: 9876543210
6. **Click**: "Pay ₹XXX - Proceed to Razorpay"
7. **Razorpay modal opens**
8. **Select**: Cards
9. **Enter test card**: `4111 1111 1111 1111`
10. **Submit**: Payment should succeed
11. **Check**: Success toast message appears
12. **Check browser console**: Payment details logged

---

## 📊 Razorpay Options Configured

```javascript
{
  key: "YOUR_RAZORPAY_KEY_ID",           // From .env
  amount: 999900,                         // Amount in paise (₹9,999 = 999900)
  currency: "INR",                        // Indian Rupees
  name: "matriXO",                        // Your business name
  description: "Event Name - Ticket Type", // Description
  image: "/logos/matrixo logo wide.png",  // Your logo
  order_id: "order_xxxx",                 // Generated by backend
  
  // Success handler - called after payment
  handler: function(response) {
    // response.razorpay_payment_id
    // response.razorpay_order_id
    // response.razorpay_signature
    // Verify on backend and show success
  },
  
  // Pre-fill customer details
  prefill: {
    name: "Customer Name",
    email: "customer@email.com",
    contact: "9876543210"
  },
  
  // Additional information
  notes: {
    event_id: "event-123",
    ticket_type: "Regular",
    quantity: 1
  },
  
  // Theme customization
  theme: {
    color: "#00d4ff"  // matriXO neon blue
  },
  
  // Modal dismiss handler
  modal: {
    ondismiss: function() {
      // User closed modal
    }
  }
}

// Payment failure handler
razorpay.on('payment.failed', function(response) {
  // response.error.code
  // response.error.description
  // response.error.source
  // response.error.step
  // response.error.reason
  // response.error.metadata.order_id
  // response.error.metadata.payment_id
})
```

---

## 🔐 Security - Signature Verification

### Why Signature Verification?

Even if payment succeeds on frontend, you must verify it on backend to prevent:
- Fraudulent payments
- Tampered payment amounts
- Replay attacks

### How It Works:

1. **Razorpay sends**: `order_id`, `payment_id`, `signature`
2. **Backend creates**: `expected_signature = HMAC(order_id + "|" + payment_id, secret_key)`
3. **Backend compares**: `expected_signature === received_signature`
4. **If match**: Payment is genuine ✅
5. **If mismatch**: Reject payment ❌

### Implementation (Already Done):

```typescript
// app/api/verify-payment/route.ts
const sign = razorpay_order_id + '|' + razorpay_payment_id
const expectedSignature = crypto
  .createHmac('sha256', process.env.RAZORPAY_KEY_SECRET)
  .update(sign.toString())
  .digest('hex')

if (razorpay_signature === expectedSignature) {
  // ✅ Payment verified - proceed
} else {
  // ❌ Invalid signature - reject
}
```

---

## 📧 Next Steps: Database & Email

### Option A: Save to MongoDB

1. **Install Mongoose**:
```bash
npm install mongoose
```

2. **Create database connection** (`lib/mongodb.ts`):
```typescript
import mongoose from 'mongoose'

const MONGODB_URI = process.env.MONGODB_URI || ''

if (!MONGODB_URI) {
  throw new Error('Please define MONGODB_URI in .env.local')
}

let cached = global.mongoose

if (!cached) {
  cached = global.mongoose = { conn: null, promise: null }
}

async function dbConnect() {
  if (cached.conn) {
    return cached.conn
  }

  if (!cached.promise) {
    cached.promise = mongoose.connect(MONGODB_URI).then((mongoose) => {
      return mongoose
    })
  }
  cached.conn = await cached.promise
  return cached.conn
}

export default dbConnect
```

3. **Create Booking model** (`models/Booking.ts`):
```typescript
import mongoose from 'mongoose'

const BookingSchema = new mongoose.Schema({
  bookingId: { type: String, required: true, unique: true },
  eventId: { type: String, required: true },
  ticketId: { type: String, required: true },
  quantity: { type: Number, required: true },
  customerName: { type: String, required: true },
  customerEmail: { type: String, required: true },
  customerPhone: { type: String, required: true },
  razorpayPaymentId: { type: String, required: true },
  razorpayOrderId: { type: String, required: true },
  amount: { type: Number, required: true },
  status: { type: String, default: 'confirmed' },
  createdAt: { type: Date, default: Date.now },
})

export default mongoose.models.Booking || mongoose.model('Booking', BookingSchema)
```

4. **Update `/api/verify-payment/route.ts`**:
```typescript
import dbConnect from '@/lib/mongodb'
import Booking from '@/models/Booking'

// Inside the signature verification success block:
await dbConnect()

const booking = await Booking.create({
  bookingId,
  eventId,
  ticketId,
  quantity: parseInt(quantity),
  customerName: customerInfo.name,
  customerEmail: customerInfo.email,
  customerPhone: customerInfo.phone,
  razorpayPaymentId: razorpay_payment_id,
  razorpayOrderId: razorpay_order_id,
  amount: parseFloat(amount),
  status: 'confirmed',
})
```

5. **Add to `.env.local`**:
```env
MONGODB_URI=mongodb+srv://username:password@cluster.mongodb.net/matrixo?retryWrites=true&w=majority
```

### Option B: Email Notifications

1. **Install Nodemailer**:
```bash
npm install nodemailer
npm install -D @types/nodemailer
```

2. **Create email service** (`lib/email.ts`):
```typescript
import nodemailer from 'nodemailer'

const transporter = nodemailer.createTransport({
  host: process.env.SMTP_HOST,
  port: parseInt(process.env.SMTP_PORT || '587'),
  secure: false,
  auth: {
    user: process.env.SMTP_USER,
    pass: process.env.SMTP_PASSWORD,
  },
})

export async function sendBookingConfirmation(
  email: string,
  booking: any
) {
  await transporter.sendMail({
    from: '"matriXO" <noreply@matrixo.in>',
    to: email,
    subject: `Registration Confirmed - ${booking.bookingId}`,
    html: `
      <!DOCTYPE html>
      <html>
      <head>
        <style>
          body { font-family: Arial, sans-serif; }
          .container { max-width: 600px; margin: 0 auto; padding: 20px; }
          .header { background: linear-gradient(to right, #00d4ff, #b400ff); padding: 20px; text-align: center; }
          .header h1 { color: white; margin: 0; }
          .content { padding: 20px; background: #f9f9f9; }
          .booking-details { background: white; padding: 15px; margin: 15px 0; border-radius: 8px; }
          .footer { text-align: center; padding: 20px; color: #666; font-size: 12px; }
        </style>
      </head>
      <body>
        <div class="container">
          <div class="header">
            <h1>🎉 Registration Confirmed!</h1>
          </div>
          <div class="content">
            <p>Hi ${booking.customerName},</p>
            <p>Your registration has been confirmed. Here are your booking details:</p>
            
            <div class="booking-details">
              <p><strong>Booking ID:</strong> ${booking.bookingId}</p>
              <p><strong>Event:</strong> ${booking.eventTitle}</p>
              <p><strong>Ticket Type:</strong> ${booking.ticketType}</p>
              <p><strong>Quantity:</strong> ${booking.quantity}</p>
              <p><strong>Amount Paid:</strong> ₹${booking.amount}</p>
              <p><strong>Payment ID:</strong> ${booking.razorpayPaymentId}</p>
            </div>
            
            <p>We'll send you the event details and joining instructions closer to the event date.</p>
            <p>If you have any questions, feel free to reach out to us.</p>
          </div>
          <div class="footer">
            <p>© 2025 matriXO. All rights reserved.</p>
            <p>MSME Registered</p>
          </div>
        </div>
      </body>
      </html>
    `,
  })
}
```

3. **Add to `.env.local`**:
```env
# Gmail SMTP
SMTP_HOST=smtp.gmail.com
SMTP_PORT=587
SMTP_USER=your-email@gmail.com
SMTP_PASSWORD=your-app-password

# Or SendGrid
# SMTP_HOST=smtp.sendgrid.net
# SMTP_PORT=587
# SMTP_USER=apikey
# SMTP_PASSWORD=your-sendgrid-api-key
```

4. **Update `/api/verify-payment/route.ts`**:
```typescript
import { sendBookingConfirmation } from '@/lib/email'

// After saving booking:
await sendBookingConfirmation(customerInfo.email, {
  bookingId,
  customerName: customerInfo.name,
  eventTitle: 'Event Name', // Get from your events data
  ticketType: 'Ticket Name',
  quantity,
  amount,
  razorpayPaymentId: razorpay_payment_id,
})
```

---

## 🚀 Going Live (Production)

### Before deploying:

1. **Get Razorpay Live Keys**:
   - Dashboard → Settings → API Keys
   - Click "Generate Live Keys"
   - Complete KYC verification

2. **Update `.env` on production**:
   ```env
   RAZORPAY_KEY_ID=rzp_live_YOUR_LIVE_KEY
   RAZORPAY_KEY_SECRET=your_live_secret
   NEXT_PUBLIC_RAZORPAY_KEY_ID=rzp_live_YOUR_LIVE_KEY
   ```

3. **Test with small amounts first** (₹10, ₹100)

4. **Setup Webhooks** (recommended):
   - Dashboard → Webhooks → Add Webhook URL
   - URL: `https://matrixo.in/api/webhook/razorpay`
   - Events: `payment.authorized`, `payment.failed`, `order.paid`
   - This ensures you get notified even if user closes browser

---

## 📱 Current Status

| Feature | Status | Notes |
|---------|--------|-------|
| Razorpay Integration | ✅ Complete | Following official docs |
| Payment Handler | ✅ Implemented | Success + failure handlers |
| Signature Verification | ✅ Implemented | Server-side security |
| Error Handling | ✅ Complete | Detailed error logging |
| Form Validation | ✅ Complete | Name, email, phone |
| Loading States | ✅ Complete | Spinner during processing |
| Toast Notifications | ✅ Complete | Success/error messages |
| Mobile Responsive | ✅ Complete | Works on all devices |
| Database Save | ⏳ Ready for setup | Code examples provided |
| Email Notifications | ⏳ Ready for setup | Code examples provided |

---

## 🐛 Troubleshooting

### "Razorpay is not defined"
- Check `.env.local` has `NEXT_PUBLIC_RAZORPAY_KEY_ID`
- Restart dev server
- Clear browser cache

### "Invalid key_id"
- Verify key starts with `rzp_test_` or `rzp_live_`
- Check no extra spaces in `.env.local`
- Ensure key is correct from dashboard

### "Signature verification failed"
- Check `RAZORPAY_KEY_SECRET` is correct
- Ensure using same keys (test with test, live with live)
- Check server logs for detailed error

### Payment succeeds but verification fails
- Check network tab in browser DevTools
- Verify `/api/verify-payment` endpoint is reachable
- Check server logs for errors

---

## 📞 Support

- **Razorpay Dashboard**: https://dashboard.razorpay.com/
- **Razorpay Docs**: https://razorpay.com/docs/
- **Razorpay Support**: support@razorpay.com
- **Test Mode Help**: https://razorpay.com/docs/payments/payments/test-card-details/

---

**Your integration is production-ready! Just add your API keys and test.** 🎉
